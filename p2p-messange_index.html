<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>P2P –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä ‚Äî –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π (—á–∞—Ç + —Ñ–∞–π–ª—ã + –ø—Ä–æ—Ñ–∏–ª—å + –ª–æ–∫–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è)</title>
  <style>
    :root{
      --bg:#0b0f1a; --card:#0f172a; --muted:#9ca3af; --line:#1f2937;
      --accent:#3b82f6; --accent-2:#2563eb; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1120,#0b0f1a);color:#e5e7eb;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,Helvetica,sans-serif}
    .app{max-width:820px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}
    .top{position:sticky;top:0;z-index:10;display:flex;align-items:center;gap:10px;padding:12px 14px;background:rgba(10,15,28,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
    .gear{width:40px;height:40px;border-radius:12px;display:grid;place-items:center;background:#111827;border:1px solid #1f2937;cursor:pointer}
    .peer{display:flex;align-items:center;gap:10px;min-width:0}
    .peer img{width:38px;height:38px;border-radius:999px;border:1px solid #1f2937;object-fit:cover;background:#111827}
    .peer .name{font-weight:700;line-height:1}
    .peer .status{font-size:12px;color:var(--muted);margin-top:2px}
    .title-wrap{display:flex;flex-direction:column;min-width:0}
    .title-wrap .name, .title-wrap .status{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .badge{margin-left:auto;padding:6px 10px;border-radius:999px;font-size:12px;background:#111827;border:1px solid var(--line)}
    .badge.ok{background:rgba(34,197,94,.18)}
    .badge.err{background:rgba(239,68,68,.18)}
    .chat-top-btn{margin-left:8px}
    .statusbar{position:sticky;top:60px;z-index:9;display:flex;gap:8px;flex-wrap:wrap;padding:8px 14px}
    .chip{padding:6px 10px;border:1px dashed #334155;border-radius:999px;font-size:12px;opacity:.95;background:rgba(17,24,39,.75)}
    .chip.warn{border-color:#8b5cf6}
    .chip.err{border-color:#ef4444}
    .chip.ok{border-color:#22c55e}
    .chip.fade{animation:fadeout 0.4s linear forwards}
    @keyframes fadeout{to{opacity:0;transform:translateY(-6px)}}
    .screen{display:none}
    .show{display:block}
    .card{margin:14px;border-radius:18px;border:1px solid var(--line);background:#0e162b;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .section{padding:14px;border-top:1px solid var(--line)}
    .section:first-child{border-top:0}
    .row{display:flex;gap:8px}
    .btn{flex:1;border:0;border-radius:12px;padding:12px 14px;font-weight:800;background:var(--accent);color:#fff;cursor:pointer}
    .btn.secondary{background:#374151}
    .btn.ok{background:var(--ok)}
    .btn.err{background:var(--err)}
    .input, textarea.input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#0b1220;color:#e5e7eb;font-size:16px}
    textarea.input{height:140px;resize:vertical;font-family:ui-monospace,Menlo,Consolas,monospace}
    .hint{font-size:12px;color:var(--muted)}
    .chat{display:flex;flex-direction:column;min-height:calc(100vh - 64px)}
    .list{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:10px; padding-bottom:98px;}
    .row-msg{display:flex;align-items:flex-end;gap:8px; position:relative;}
    .row-msg.me{justify-content:flex-end}
    .msg{max-width:78%;background:#0b1220;border:1px solid #20304d;padding:10px 12px;border-radius:16px 16px 16px 6px;}
    .me .msg{background:#112246;border-color:#2b4a84;border-radius:16px 16px 6px 16px}
    .bubble{white-space:pre-wrap;word-wrap:anywhere}
    .meta{font-size:11px;color:var(--muted);margin-top:3px;text-align:right}
    .sys{align-self:center;opacity:.8;font-size:12px;padding:6px 10px;border:1px dashed #334155;border-radius:10px}
    .img-msg{max-width:66vw; border-radius:12px; display:block}
    .file-link{display:inline-flex;align-items:center;gap:8px;text-decoration:none;color:#93c5fd;word-break:break-all}
    .progress{height:6px;background:#0b1220;border:1px solid #20304d;border-radius:12px;overflow:hidden;margin-top:6px}
    .bar{height:100%;background:#3b82f6;width:0%}
    .composer{position:fixed;left:50%;transform:translateX(-50%);bottom:0;right:0;width:100%;max-width:820px;display:flex;gap:8px;padding:10px;background:rgba(10,15,28,.96);backdrop-filter:blur(8px);border-top:1px solid var(--line)}
    .composer input[type="text"]{flex:1}
    #file{display:none}
    .msg-ava{width:28px;height:28px;border-radius:999px;object-fit:cover;border:1px solid #1f2937;background:#111827}
    .msg .edited{font-size:11px;color:var(--muted);margin-top:3px}
    .actions-overlay{position:fixed;inset:0;display:none;align-items:flex-end;background:rgba(0,0,0,.45);z-index:50}
    .actions{width:100%;max-width:820px;margin:0 auto;background:var(--card);border-top-left-radius:16px;border-top-right-radius:16px;
      border:1px solid var(--line);box-shadow:0 -10px 30px rgba(0,0,0,.5);transform:translateY(100%);transition:.25s ease}
    .actions.show{transform:translateY(0)}
    .actions .btns{display:grid;gap:8px;padding:14px}
    .actions .a-btn{padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#0f172a;font-weight:600;text-align:center}
    .actions .a-btn.danger{background:rgba(239,68,68,.15);border-color:#3f2121}
    .actions .a-btn.red{background:#7f1d1d;border-color:#7f1d1d;color:#fff}
    .sheet{position:fixed;inset:0;display:none;align-items:flex-end;background:rgba(0,0,0,.4);z-index:20}
    .sheet .box{width:100%;max-width:820px;margin:0 auto;background:#0e162b;border-top-left-radius:18px;border-top-right-radius:18px;border:1px solid var(--line);box-shadow:0 -10px 30px rgba(0,0,0,.45)}
    .sheet .head{display:flex;align-items:center;justify-content:center;padding:10px;border-bottom:1px solid var(--line);font-weight:800}
    .sheet .inner{padding:14px;display:grid;gap:12px}
    .ava-wrap{display:flex;align-items:center;gap:12px}
    .ava-wrap img{width:64px;height:64px;border-radius:999px;border:1px solid #1f2937;object-fit:cover;background:#111827}
    .sheet .actions{display:flex;gap:10px}
    @keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
  </style>
</head>
<body>
<div class="app">
  <div class="top">
    <div id="gear" class="gear" title="–ü—Ä–æ—Ñ–∏–ª—å">‚öôÔ∏è</div>
    <div class="peer">
      <img id="peerAva" alt="peer avatar"/>
      <div class="title-wrap">
        <div id="peerName" class="name">–°–æ–±–µ—Å–µ–¥–Ω–∏–∫</div>
        <div id="peerStatus" class="status">–Ω–µ –≤ —Å–µ—Ç–∏</div>
      </div>
    </div>
    <div id="connBadge" class="badge">–ö–∞–Ω–∞–ª –æ—Ç–∫—Ä—ã—Ç</div>
  </div>
  <div id="statusbar" class="statusbar"></div>
  <div id="screenConnect" class="screen show">
    <div class="card">
      <div class="section">
        <div class="hint">1) –í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</div>
        <div class="row" style="margin-top:8px">
          <button id="hostBtn" class="btn">–°–æ–∑–¥–∞—Ç—å (—Ö–æ—Å—Ç)</button>
          <button id="joinBtn" class="btn secondary">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è (–≥–æ—Å—Ç—å)</button>
        </div>
      </div>
      <div class="section">
        <div class="hint">2) –û–±–º–µ–Ω —Ç–µ–∫—Å—Ç–æ–º –Ω–∏–∂–µ. <b>–í–µ—Ä–Ω–∏—Ç–µ –æ—Ç–≤–µ—Ç —Ö–æ—Å—Ç—É</b></div>
        <textarea id="signalBox" class="input" placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –æ—Ñ—Ñ–µ—Ä/–æ—Ç–≤–µ—Ç"></textarea>
        <div class="row" style="margin-top:8px">
          <button id="copyBtn" class="btn secondary">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          <button id="applyBtn" class="btn ok">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          <button id="resetBtn" class="btn err">–°–±—Ä–æ—Å</button>
        </div>
      </div>
    </div>
  </div>
  <div id="screenChat" class="screen">
    <div id="list" class="list"></div>
    <div class="composer">
      <input id="text" class="input" type="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶"/>
      <input id="file" type="file" accept="image/*,audio/*,video/*,application/octet-stream,*/*"/>
      <button id="attach" class="btn secondary">üìé</button>
      <button id="send" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
  <div id="actOverlay" class="actions-overlay">
    <div class="actions" id="actSheet">
      <div class="btns">
        <button id="actEdit" class="a-btn">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
        <button id="actDelMe" class="a-btn danger">üóë –£–¥–∞–ª–∏—Ç—å —É —Å–µ–±—è</button>
        <button id="actDelAll" class="a-btn red">‚ùå –£–¥–∞–ª–∏—Ç—å —É –≤—Å–µ—Ö</button>
      </div>
    </div>
  </div>
</div>
<div id="sheet" class="sheet">
  <div class="box">
    <div class="head">–ü—Ä–æ—Ñ–∏–ª—å</div>
    <div class="inner">
      <div class="ava-wrap">
        <img id="myAva" alt="my avatar"/>
        <div>
          <div class="hint">–ê–≤–∞—Ç–∞—Ä</div>
          <input id="avaFile" type="file" accept="image/*"/>
        </div>
      </div>
      <div>
        <div class="hint">–ò–º—è</div>
        <input id="myName" class="input" placeholder="–ö–∞–∫ –≤–∞—Å –Ω–∞–∑—ã–≤–∞—Ç—å?"/>
      </div>
      <div class="actions">
        <button id="saveProfile" class="btn ok">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="closeSheet" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>
</div>
<script>
window.addEventListener('DOMContentLoaded', () => {
  const $ = (id)=>document.getElementById(id);
  const UI = {
    host: $('hostBtn'), join: $('joinBtn'), signalBox: $('signalBox'), copy: $('copyBtn'), apply: $('applyBtn'), reset: $('resetBtn'),
    list: $('list'), text: $('text'), file: $('file'), attach: $('attach'), send: $('send'),
    badge: $('connBadge'), screenChat: $('screenChat'), screenConnect: $('screenConnect'),
    peerName: $('peerName'), peerAva: $('peerAva'), peerStatus: $('peerStatus'),
    sheet: $('sheet'), gear: $('gear'), myName: $('myName'), myAva: $('myAva'), avaFile: $('avaFile'), saveProfile: $('saveProfile'), closeSheet: $('closeSheet'),
    statusbar: $('statusbar')
  };

  let S = {
    isHost: false,
    pc: null,
    dc: null,
    heartbeatTimer: null,
    typingTimer: null,
    offlineTimer: null,
    lastHeartbeatAt: 0,
    peer: { name: '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫', ava: '', lastSeen: 0 },
    me: { name: '–í—ã', avaB64: '' },
    incoming: new Map()
  };

  // --- UI ---
  function setBadge(t, cls){ UI.badge.textContent = t; UI.badge.className = 'badge ' + (cls||''); }
  function addChip(text, kind){ const chip = document.createElement('div'); chip.className = 'chip '+(kind||''); chip.textContent=text; UI.statusbar.appendChild(chip); setTimeout(()=>{chip.classList.add('fade'); setTimeout(()=>chip.remove(),400)},2400); }
  function logSys(text){ const d=document.createElement('div'); d.className='sys'; d.textContent=text; UI.list.appendChild(d); UI.list.scrollTop = UI.list.scrollHeight; }
  function scrollChat(){ UI.list.scrollTop = UI.list.scrollHeight; }
  function hhmm(ts){ const d=ts?new Date(ts):new Date(); const h=String(d.getHours()).padStart(2,'0'); const m=String(d.getMinutes()).padStart(2,'0'); return h+':'+m; }
  function humanSize(n){ const u=['B','KB','MB','GB']; let i=0; while(n>1024 && i<u.length-1){ n/=1024; i++; } return n.toFixed((i>0)?1:0)+' '+u[i]; }

  // --- Renderers ---
  function renderText(msg, mine, ts, id=null, edited=false){
    const row = document.createElement('div'); row.className = 'row-msg '+(mine?'me':'');
    row.dataset.id = id || ('m'+Date.now()+Math.random().toString(16).slice(2));
    const ava = document.createElement('img'); ava.className='msg-ava'; ava.src = mine ? (S.me.avaB64||'') : (S.peer.ava||''); ava.alt='ava';
    const bubble = document.createElement('div'); bubble.className = 'msg';
    const t = document.createElement('div'); t.className = 'bubble'; t.textContent = msg;
    if(edited){ const ed = document.createElement('div'); ed.className='edited'; ed.textContent='–∏–∑–º–µ–Ω–µ–Ω–æ'; bubble.appendChild(ed); }
    const meta = document.createElement('div'); meta.className='meta'; meta.textContent = hhmm(ts);
    bubble.appendChild(t); bubble.appendChild(meta);
    if(mine){ row.appendChild(bubble); row.appendChild(ava); } else { row.appendChild(ava); row.appendChild(bubble); }
    UI.list.appendChild(row); scrollChat();
  }
  function renderImage(blobUrl, mine, id=null){
    const row = document.createElement('div'); row.className = 'row-msg '+(mine?'me':'');
    if(id) row.dataset.id = id;
    const ava = document.createElement('img'); ava.className='msg-ava'; ava.src = mine ? (S.me.avaB64||'') : (S.peer.ava||''); ava.alt='ava';
    const bubble = document.createElement('div'); bubble.className = 'msg';
    const img = document.createElement('img'); img.className='img-msg'; img.src = blobUrl; img.alt = 'image';
    const meta = document.createElement('div'); meta.className='meta'; meta.textContent = hhmm();
    bubble.appendChild(img); bubble.appendChild(meta);
    if(mine){ row.appendChild(bubble); row.appendChild(ava); } else { row.appendChild(ava); row.appendChild(bubble); }
    UI.list.appendChild(row); scrollChat();
  }
  function renderAudio(blobUrl, name, mine, id=null){
    const row = document.createElement('div'); row.className = 'row-msg '+(mine?'me':'');
    if(id) row.dataset.id = id;
    const ava = document.createElement('img'); ava.className='msg-ava'; ava.src = mine ? (S.me.avaB64||'') : (S.peer.ava||''); ava.alt='ava';
    const bubble = document.createElement('div'); bubble.className = 'msg';
    const audio = document.createElement('audio'); audio.controls=true; audio.src=blobUrl;
    bubble.appendChild(audio);
    const meta = document.createElement('div'); meta.className='meta'; meta.textContent = name+' '+hhmm();
    bubble.appendChild(meta);
    if(mine){ row.appendChild(bubble); row.appendChild(ava); } else { row.appendChild(ava); row.appendChild(bubble); }
    UI.list.appendChild(row); scrollChat();
  }
  function renderFileLink(name, blobUrl, size, mine, id=null){
    const row = document.createElement('div'); row.className = 'row-msg '+(mine?'me':'');
    if(id) row.dataset.id = id;
    const ava = document.createElement('img'); ava.className='msg-ava'; ava.src = mine ? (S.me.avaB64||'') : (S.peer.ava||''); ava.alt='ava';
    const bubble = document.createElement('div'); bubble.className = 'msg';
    const a = document.createElement('a'); a.href = blobUrl; a.download = name; a.className='file-link'; a.textContent = 'üìé '+name+' ('+humanSize(size)+')';
    const meta = document.createElement('div'); meta.className='meta'; meta.textContent = hhmm();
    bubble.appendChild(a); bubble.appendChild(meta);
    if(mine){ row.appendChild(bubble); row.appendChild(ava); } else { row.appendChild(ava); row.appendChild(bubble); }
    UI.list.appendChild(row); scrollChat();
  }
  function renderProgress(id, labelText, total, mine){
    const row = document.createElement('div'); row.className='row-msg '+(mine?'me':''); row.dataset.id=id;
    const bubble = document.createElement('div'); bubble.className='msg';
    const label = document.createElement('div'); label.textContent = labelText + ' ('+humanSize(total)+')';
    const wrap = document.createElement('div'); wrap.className='progress';
    const bar = document.createElement('div'); bar.className='bar'; wrap.appendChild(bar);
    bubble.appendChild(label); bubble.appendChild(wrap); row.appendChild(bubble); UI.list.appendChild(row); scrollChat();
    return bar;
  }
  function updateProgress(id, pct){ const row = UI.list.querySelector('[data-id="'+id+'"]'); if(!row) return; const bar = row.querySelector('.bar'); if(bar) bar.style.width = pct+'%'; if(pct>=100) setTimeout(()=>row.remove(), 600); }

  // --- Profile ---
  function saveLocalProfile(){ localStorage.setItem('p2p_name', S.me.name||''); localStorage.setItem('p2p_ava_b64', S.me.avaB64||''); }
  function loadLocalProfile(){
    S.me.name = localStorage.getItem('p2p_name') || '–í—ã';
    S.me.avaB64 = localStorage.getItem('p2p_ava_b64') || '';
    UI.myName.value = S.me.name;
    UI.myAva.src = S.me.avaB64 || '';
  }

  function setPeerProfile(name, avaB64){
    S.peer.name = name || '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫';
    S.peer.ava = avaB64 || '';
    UI.peerName.textContent = S.peer.name;
    UI.peerAva.src = S.peer.ava || '';
  }

  // --- Image resize ---
  function resizeImageToBlob(file, maxSize=256, quality=0.8){
    return new Promise((resolve)=>{
      const img=new Image();
      const reader=new FileReader();
      reader.onload=(e)=>{ img.src=e.target.result; };
      img.onload=()=>{
        let canvas=document.createElement('canvas');
        const ratio=Math.min(maxSize/img.width, maxSize/img.height, 1);
        canvas.width = Math.max(1, Math.round(img.width*ratio));
        canvas.height= Math.max(1, Math.round(img.height*ratio));
        const ctx=canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        canvas.toBlob((blob)=>{
          const reader2=new FileReader();
          reader2.onload=()=> resolve({blob, b64: reader2.result});
          reader2.readAsDataURL(blob);
        }, 'image/jpeg', quality);
      };
      reader.readAsDataURL(file);
    });
  }

  // --- WebRTC ---
  async function createPC(){
    S.pc = new RTCPeerConnection({ iceServers: [
      {urls:'stun:stun.l.google.com:19302'},
      {urls:'stun:stun1.l.google.com:19302'}
    ]});
    S.pc.onconnectionstatechange = ()=>{
      const s = S.pc.connectionState;
      if(s==='connected'){
        setBadge('–ö–∞–Ω–∞–ª –æ—Ç–∫—Ä—ã—Ç','ok');
        UI.screenChat.classList.add('show'); UI.screenConnect.classList.remove('show');
        logSys('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
        setOnline();
        heartbeatStart();
        sendProfileName();
        if(S.me.avaB64) sendAvatarFromB64(S.me.avaB64);
      } else if(s==='connecting'){
        setBadge('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ‚Ä¶');
      } else if(s==='disconnected'){
        setBadge('–û—Ç–∫–ª—é—á–µ–Ω–æ','err');
        heartbeatStop();
        setLastSeen();
        addChip('–°–≤—è–∑—å –ø–æ—Ç–µ—Ä—è–Ω–∞, –ø—Ä–æ–±—É—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å‚Ä¶','warn');
        tryIceRestart();
      } else if(s==='failed'){
        setBadge('–ù–µ —É–¥–∞–ª–æ—Å—å','err');
        heartbeatStop();
        addChip('–ö–∞–Ω–∞–ª –∑–∞–∫—Ä—ã—Ç','err');
      } else {
        setBadge(s);
      }
    };
    S.pc.oniceconnectionstatechange = ()=>{
      if(S.pc.iceConnectionState==='disconnected'){
        addChip('ICE: disconnected','warn');
        tryIceRestart();
      }
    };
    if(!S.isHost){ S.pc.ondatachannel = (e)=> bindDC(e.channel); }
  }

  function bindDC(channel){
    S.dc = channel;
    S.dc.binaryType = 'arraybuffer';
    S.dc.bufferedAmountLowThreshold = 256*1024;
    S.dc.onopen = ()=>{ addChip('DC open','ok'); };
    S.dc.onclose = ()=>{ addChip('DC close','err'); };
    S.dc.onmessage = onDCMessage;
  }
  function signalToBox(desc){ UI.signalBox.value = JSON.stringify(desc); }
  function waitIce(pc){ return new Promise((res)=>{
    if(pc.iceGatheringState==='complete') return res();
    const f=()=>{ if(pc.iceGatheringState==='complete'){ pc.removeEventListener('icegatheringstatechange',f); res(); } };
    pc.addEventListener('icegatheringstatechange',f);
    setTimeout(()=>{ pc.removeEventListener('icegatheringstatechange',f); res(); }, 15000);
  }); }
  async function tryIceRestart(){
    try{
      const offer = await S.pc.createOffer({iceRestart:true});
      await S.pc.setLocalDescription(offer);
      await waitIce(S.pc);
      signalToBox(S.pc.localDescription);
      addChip('üîÅ –û—Ç–ø—Ä–∞–≤—å –Ω–æ–≤—ã–π –æ—Ñ—Ñ–µ—Ä —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É','warn');
    }catch(e){}
  }

  function setOnline(){ UI.peerStatus.textContent='–æ–Ω–ª–∞–π–Ω'; }
  function setTyping(){ UI.peerStatus.textContent='–ü–µ—á–∞—Ç–∞–µ—Ç‚Ä¶'; clearTimeout(S.typingTimer); S.typingTimer = setTimeout(()=>{ setOnline(); }, 1500); }
  function setLastSeen(ts){ const t = ts || S.peer.lastSeen || S.lastHeartbeatAt || Date.now(); UI.peerStatus.textContent = '–±—ã–ª(–∞) –≤ —Å–µ—Ç–∏ '+hhmm(t); }
  function onHeartbeat(){ S.lastHeartbeatAt = Date.now(); S.peer.lastSeen = S.lastHeartbeatAt; setOnline(); if(S.offlineTimer) clearTimeout(S.offlineTimer); S.offlineTimer = setTimeout(()=>{ setLastSeen(S.peer.lastSeen); }, 8000); }

  // --- DC Protocol JSON ---
  function sendJSON(obj){ if(S.dc && S.dc.readyState==='open'){ S.dc.send(JSON.stringify(obj)); } }

  // ---- FIX: Don't render system/service messages ----
  function onDCMessage(ev){
    const data = ev.data;
    if(typeof data === 'string'){
      try{
        const obj = JSON.parse(data);
        if(obj && obj.t){
          handleJSON(obj); // ONLY handle, don't render anything except user messages
          return;
        }
      }catch(_){}
      // if not a JSON, treat as text message from peer
      renderText(String(data), false, Date.now());
      return;
    }
    handleBinaryChunk(data);
  }

  function handleJSON(obj){
    // Only react to user-level messages for rendering
    switch(obj.t){
      case 'text':
        renderText(obj.body, false, Date.now(), obj.id);
        break;
      case 'edit':
        const row = UI.list.querySelector('[data-id="'+obj.id+'"]');
        if(row){
          const bubble = row.querySelector('.bubble');
          if(bubble) bubble.textContent = obj.body;
          if(!row.querySelector('.edited')) {
            const ed = document.createElement('div');
            ed.className='edited';
            ed.textContent='–∏–∑–º–µ–Ω–µ–Ω–æ';
            row.querySelector('.msg').appendChild(ed);
          }
        }
        break;
      case 'delete':
        const delRow = UI.list.querySelector('[data-id="'+obj.id+'"]');
        if(delRow) delRow.remove();
        break;
      case 'profile':
        setPeerProfile(obj.name, S.peer.ava); // name set, ava will come via ava-done
        break;
      case 'ava-meta':
        // –ü–æ–ª—É—á–∞–µ–º –∞–≤–∞—Ç–∞—Ä –ø–æ —á–∞—Å—Ç—è–º (–∫–∞–∫ —Ñ–∞–π–ª)
        S.incoming.set(obj.id, { meta: obj, kind: 'ava', chunks: [], received: 0 });
        break;
      case 'ava-done':
        const entry = S.incoming.get(obj.id);
        if(entry){
          const chunks = entry.chunks.filter(Boolean);
          const blob = new Blob(chunks, {type: entry.meta.mime});
          const url = URL.createObjectURL(blob);
          S.peer.ava = url;
          UI.peerAva.src = url;
          S.incoming.delete(obj.id);
        }
        break;
      case 'file-meta':
        S.incoming.set(obj.id, { meta: obj, kind: 'file', chunks: [], received: 0 });
        renderProgress(obj.id, '–ü–æ–ª—É—á–∞—é '+obj.name, obj.size, false);
        break;
      case 'file-done':
        // handled in handleBinaryChunk (below)
        break;
      case 'typing':
        setTyping();
        break;
      case 'heartbeat':
        onHeartbeat();
        break;
      case 'presence':
        setLastSeen();
        break;
      // ignore all other system/service messages
    }
  }

  function handleBinaryChunk(buf){
    const dv = new DataView(buf);
    const idHi = dv.getUint32(0); const idLo = dv.getUint32(4); const seq = dv.getUint32(8);
    const id = idHi.toString(16).padStart(8,'0')+idLo.toString(16,'0');
    const payload = buf.slice(12);
    const entry = S.incoming.get(id); if(!entry) return;
    entry.chunks[seq] = payload; entry.received += payload.byteLength;
    const pct = Math.min(99, Math.round( entry.received / entry.meta.size * 100 ));
    updateProgress(id, pct);
    // –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ –≤–µ—Å—å —Ñ–∞–π–ª - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
    if(entry.received >= entry.meta.size) {
      const meta = entry.meta;
      const chunks = entry.chunks.filter(Boolean);
      const blob = new Blob(chunks, {type: meta.mime});
      const url = URL.createObjectURL(blob);
      setTimeout(()=> {
        // —É–¥–∞–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
        const row = UI.list.querySelector('[data-id="'+id+'"]');
        if(row) row.remove();
        // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∞–π–ª
        if(meta.mime.startsWith('image/')) renderImage(url, false, id);
        else if(meta.mime.startsWith('audio/')) renderAudio(url, meta.name, false, id);
        else renderFileLink(meta.name, url, meta.size, false, id);
        S.incoming.delete(id);
      }, 100);
    }
  }

  // --- Heartbeat ---
  function heartbeatStart(){ heartbeatStop(); S.heartbeatTimer = setInterval(()=> sendJSON({t:'heartbeat'}), 4000); }
  function heartbeatStop(){ if(S.heartbeatTimer){ clearInterval(S.heartbeatTimer); S.heartbeatTimer=null; } }

  // --- Profile: name/ava ---
  function sendProfileName(){ sendJSON({t:'profile', name:S.me.name}); }
  async function sendAvatarBlob(blob){
    if(!S.dc || S.dc.readyState!=='open') return;
    const CHUNK = 64*1024;
    const idHi = (Math.random()*0xffffffff)>>>0; const idLo = (Math.random()*0xffffffff)>>>0;
    const idHex = idHi.toString(16).padStart(8,'0')+idLo.toString(16,'0');
    const arrayBuf = await blob.arrayBuffer();
    sendJSON({t:'ava-meta', id:idHex, size: arrayBuf.byteLength, mime: blob.type || 'image/jpeg'});
    for(let seq=0, off=0; off<arrayBuf.byteLength; seq++, off+=CHUNK){
      const size = Math.min(CHUNK, arrayBuf.byteLength-off);
      const payload = arrayBuf.slice(off, off+size);
      const header = new ArrayBuffer(12); const dv = new DataView(header);
      dv.setUint32(0, idHi); dv.setUint32(4, idLo); dv.setUint32(8, seq);
      const packet = new Uint8Array(12 + size); packet.set(new Uint8Array(header),0); packet.set(new Uint8Array(payload),12);
      S.dc.send(packet);
      if(S.dc.bufferedAmount > S.dc.bufferedAmountLowThreshold){
        await new Promise(r=>{ const onLow=()=>{ S.dc.removeEventListener('bufferedamountlow', onLow); r(); }; S.dc.addEventListener('bufferedamountlow', onLow); });
      }
    }
    sendJSON({t:'ava-done', id:idHex});
  }
  async function sendAvatarFromB64(b64){
    try{
      const blob = await (await fetch(b64)).blob();
      await sendAvatarBlob(blob);
    }catch(e){ console.warn('sendAvatarFromB64 error', e); }
  }

  // --- File send (chat attach) ---
  UI.attach.addEventListener('click', ()=> UI.file.click());
  UI.file.addEventListener('change', ()=>{ const f = UI.file.files[0]; if(!f) return; sendFile(f); UI.file.value = ''; });
  async function sendFile(file){
    if(!S.dc || S.dc.readyState!=='open') return;
    const CHUNK = 64*1024;
    const idHi = (Math.random()*0xffffffff)>>>0; const idLo = (Math.random()*0xffffffff)>>>0;
    const idHex = idHi.toString(16).padStart(8,'0')+idLo.toString(16,'0');
    sendJSON({t:'file-meta', id:idHex, name:file.name, size:file.size, mime:file.type||'application/octet-stream'});
    const arrayBuf = await file.arrayBuffer();
    const blobUrl = URL.createObjectURL(new Blob([arrayBuf], {type:file.type||'application/octet-stream'}));
    renderProgress(idHex, '–û—Ç–ø—Ä–∞–≤–ª—è—é '+file.name, file.size, true);
    for(let seq=0, off=0; off<arrayBuf.byteLength; seq++, off+=CHUNK){
      const size = Math.min(CHUNK, arrayBuf.byteLength-off);
      const payload = arrayBuf.slice(off, off+size);
      const header = new ArrayBuffer(12); const dv = new DataView(header);
      dv.setUint32(0, idHi); dv.setUint32(4, idLo); dv.setUint32(8, seq);
      const packet = new Uint8Array(12 + size); packet.set(new Uint8Array(header),0); packet.set(new Uint8Array(payload),12);
      S.dc.send(packet);
      let pct = Math.round((off + size) / arrayBuf.byteLength * 100);
      updateProgress(idHex, pct);
      if(S.dc.bufferedAmount > S.dc.bufferedAmountLowThreshold){
        await new Promise(r=>{ const onLow=()=>{ S.dc.removeEventListener('bufferedamountlow', onLow); r(); }; S.dc.addEventListener('bufferedamountlow', onLow); });
      }
    }
    updateProgress(idHex, 100);
    setTimeout(()=> {
      const row = UI.list.querySelector('[data-id="'+idHex+'"]');
      if(row) row.remove();
      if((file.type||'').startsWith('image/')) renderImage(blobUrl, true, idHex);
      else if((file.type||'').startsWith('audio/')) renderAudio(blobUrl, file.name, true, idHex);
      else renderFileLink(file.name, blobUrl, file.size, true, idHex);
    }, 600);
    sendJSON({t:'file-done', id:idHex});
  }

  // --- Text & typing ---
  UI.text.addEventListener('input', ()=>{ sendJSON({t:'typing'}); });
  UI.send.addEventListener('click', ()=>{
    if(!S.dc || S.dc.readyState!=='open') return;
    const msg = UI.text.value.trim(); if(!msg) return; UI.text.value='';
    const _id = 'm'+Date.now()+Math.random().toString(16).slice(2);
    sendJSON({t:'text', id:_id, body: msg});
    renderText(msg, true, Date.now(), _id);
  });

  // --- Actions modal ---
  const ACT = { overlay: document.getElementById('actOverlay'), sheet: document.getElementById('actSheet'),
    edit: document.getElementById('actEdit'), delMe: document.getElementById('actDelMe'), delAll: document.getElementById('actDelAll'),
    targetId: null };
  function openActions(id){
    ACT.targetId = id;
    ACT.overlay.style.display='flex';
    requestAnimationFrame(()=> ACT.sheet.classList.add('show'));
  }
  function closeActions(){
    ACT.sheet.classList.remove('show');
    setTimeout(()=>{ ACT.overlay.style.display='none'; ACT.targetId=null; }, 200);
  }
  ACT.overlay.addEventListener('click', (e)=>{ if(e.target===ACT.overlay) closeActions(); });
  UI.list.addEventListener('click', (e)=>{
    const row = e.target.closest('.row-msg.me, .row-msg:not(.me)'); if(!row) return;
    openActions(row.dataset.id);
  });
  ACT.edit.addEventListener('click', ()=>{
    const row = UI.list.querySelector('[data-id="'+ACT.targetId+'"]'); if(!row) return;
    const bubble = row.querySelector('.bubble'); const oldText = bubble ? bubble.firstChild.textContent : '';
    const next = prompt('–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', oldText);
    if(next!==null){
      if(bubble){ bubble.firstChild.textContent = next; if(!bubble.querySelector('.edited')){ const ed=document.createElement('div'); ed.className='edited'; ed.textContent='–∏–∑–º–µ–Ω–µ–Ω–æ'; bubble.appendChild(ed);} }
      try{ if(S.dc && S.dc.readyState==='open') sendJSON({t:'edit', id: ACT.targetId, body: next}); }catch(_){}
    }
    closeActions();
  });
  ACT.delMe.addEventListener('click', ()=>{
    const row = UI.list.querySelector('[data-id="'+ACT.targetId+'"]'); if(row) row.remove();
    closeActions();
  });
  ACT.delAll.addEventListener('click', ()=>{
    const row = UI.list.querySelector('[data-id="'+ACT.targetId+'"]'); if(row) row.remove();
    try{ if(S.dc && S.dc.readyState==='open') sendJSON({t:'delete', id: ACT.targetId}); }catch(_){}
    closeActions();
  });

  // --- Settings sheet ---
  UI.gear.addEventListener('click', ()=>{ UI.sheet.style.display='flex'; });
  UI.closeSheet.addEventListener('click', ()=>{ UI.sheet.style.display='none'; });
  UI.saveProfile.addEventListener('click', ()=>{
    S.me.name = UI.myName.value.trim() || '–í—ã';
    saveLocalProfile();
    UI.sheet.style.display='none';
    sendProfileName();
    addChip('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω','ok');
    UI.peerAva.src = S.peer.ava || '';
  });
  UI.avaFile.addEventListener('change', async ()=>{
    const f = UI.avaFile.files[0]; if(!f) return;
    addChip('–°–∂–∏–º–∞—é –∞–≤–∞—Ç–∞—Ä‚Ä¶');
    const {blob, b64} = await resizeImageToBlob(f, 256, 0.8);
    S.me.avaB64 = b64; UI.myAva.src = b64; saveLocalProfile();
    if(S.dc && S.dc.readyState==='open'){ addChip('–û—Ç–ø—Ä–∞–≤–ª—è—é –∞–≤–∞—Ç–∞—Ä‚Ä¶'); await sendAvatarBlob(blob); addChip('–ê–≤–∞—Ç–∞—Ä –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω','ok'); }
  });

  // --- Connect flow ---
  UI.host.addEventListener('click', async ()=>{
    S.isHost = true; await createPC();
    const dc = S.pc.createDataChannel('chat'); bindDC(dc);
    const offer = await S.pc.createOffer(); await S.pc.setLocalDescription(offer); await waitIce(S.pc);
    signalToBox(S.pc.localDescription); logSys('‚ö†Ô∏è –ü–µ—Ä–µ–¥–∞–π —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –≥–æ—Å—Ç—é –∏ –∂–¥–∏ –æ—Ç–≤–µ—Ç'); setBadge('–ñ–¥—ë–º –æ—Ç–≤–µ—Ç‚Ä¶');
    localStorage.setItem('p2p_role','host');
  });
  UI.join.addEventListener('click', async ()=>{ S.isHost = false; await createPC(); addChip('–í—Å—Ç–∞–≤—å –æ—Ñ—Ñ–µ—Ä —Ö–æ—Å—Ç–∞ –∏ –Ω–∞–∂–º–∏ –ü—Ä–∏–º–µ–Ω–∏—Ç—å'); localStorage.setItem('p2p_role','guest'); });
  UI.apply.addEventListener('click', async ()=>{
    try{
      const desc = JSON.parse(UI.signalBox.value.trim());
      if(desc.type==='offer'){
        await S.pc.setRemoteDescription(desc);
        const answer = await S.pc.createAnswer(); await S.pc.setLocalDescription(answer); await waitIce(S.pc);
        signalToBox(S.pc.localDescription); logSys('‚ö†Ô∏è –í–µ—Ä–Ω–∏ —ç—Ç–æ—Ç –æ—Ç–≤–µ—Ç —Ö–æ—Å—Ç—É'); setBadge('–û—Ç–≤–µ—Ç –≥–æ—Ç–æ–≤','ok');
      } else if(desc.type==='answer'){
        await S.pc.setRemoteDescription(desc); logSys('‚úÖ –û—Ç–≤–µ—Ç –ø—Ä–∏–Ω—è—Ç, –∂–¥—ë–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞');
      } else { alert('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø: '+desc.type); }
    } catch(e){ alert('–û—à–∏–±–∫–∞: '+e.message); }
  });
  UI.copy.addEventListener('click', ()=>{
    const txt = UI.signalBox.value.trim();
    if(!txt){ addChip('–ü–æ–ª–µ –ø—É—Å—Ç–æ–µ','warn'); return; }
    navigator.clipboard.writeText(txt).then(()=>{
      addChip('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞','ok');
    }).catch(()=> addChip('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è','err'));
  });
  UI.reset.addEventListener('click', ()=>{
    UI.signalBox.value = '';
    addChip('–ü–æ–ª–µ –æ—á–∏—â–µ–Ω–æ','warn');
  });
  document.addEventListener('visibilitychange', ()=>{ if(document.hidden) { sendJSON({t:'presence', state:'away'}); } else { sendJSON({t:'heartbeat'}); } });
  window.addEventListener('pagehide', ()=>{ sendJSON({t:'presence', state:'bye'}); });
  function loadPeerHeader(){ UI.peerName.textContent = S.peer.name; UI.peerAva.src = S.peer.ava || ''; }
  loadLocalProfile(); loadPeerHeader(); setBadge('–ö–∞–Ω–∞–ª –æ—Ç–∫—Ä—ã—Ç');
});
</script>
</body>
</html>